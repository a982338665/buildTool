
###1.在设计API时，要保证RESTful API的安全性，主要考虑三个大方面：

    1.对受限资源的登录授权
    2.对请求做身份认证
    3.对敏感数据进行加密

####一、受限资源的登录授权
    
    此流程不是本文重点，不赘述，基本流程如下：
    客户端提交账号信息（用户名+密码）到服务端
    服务端验证成功，返回AccessToken给客户端存储
    3.访问受限资源时，客户端带入AccessToken就可访问。

####二、请求认证

    如果不对请求进行签名认证，那么可以简单的通过fiddler等工具轻易抓包拿到数据，并进行篡改，提交，大规模批量调用，则会使系统产生大量垃圾数据，系统资源被大量消耗，
    甚至无法正常使用（另说，当然可以通过GateWay进行限流），因而我们需要对请求进行签名认证。
    URL格式
    URL:schema://domain/path?query&imei×tamp&sign
    参数说明
    签名方法
    sign=signature(path?query&imei×tamp&SIGN_KEY)

####验证过程

    认证逻辑
    1、初始时，服务端存有各App版本的SIGN_KEY，客户端存有对应版本的SIGN_KEY
    2、当要发送请求之前，通过签名方法加密，得到一个sign
    3、发送请求的时候，连同sign一起发送给服务器端
    4、服务器端首先验证时间戳timestamp是否有效，比如是服务器时间戳5分钟之前的请求视为无效；
    5、然后取对应版本的SIGN_KEY验证sign是否合法
    6、为了防止重放攻击，需要检查sign是否在redis中存储，如不存在则存入redis（缓存5分钟）
    
    如何防止数据篡改
    这里通过签名参数中包含原有请求的所有参数，改动任意参数，sign值都会不同，因此无法篡改。
    
    如何防止重放攻击
    由于签名算法中还有imei(设备唯一Id)、timestamp参数，且签名算法为不可逆算法（如md5或sha1），因而对于正常的每个请求sign值不会重复。此时服务端可以存储5分钟的sign值，来做重放攻击时的验证过滤，超过5分钟的请求则直接被timestamp校验过滤。
    
    总结
    如此便实现了请求认证，防止数据篡改，重放攻击，但是需要确保App密钥(SIGN_KEY)的安全保存，其优点是容易理解与实现，缺点是需要承担安全保存密钥和定期更新密钥的负担。

####三、敏感据加密
    1)、部署SSL基础设施（即HTTPS），敏感数据的传输全部基于SSL。
    2)、仅对部分敏感数据做加密（例如账号+密码），并加入某种随机数作为加密盐，以防范数据被篡改。

### 接口幂等性保证：
    
    什么是幂等性
    一个接口被重复调用，对系统的影响是一致的。无论是一次还是多次，数据是一致的，效果也一样。
    
    什么情况下需要幂等
    SELECT col1 FROM tab1 WHER col2=2，无论执行多少次都不会改变状态，是天然的幂等。
    UPDATE tab1 SET col1=1 WHERE col2=2，无论执行成功多少次状态都是一致的，因此也是幂等操作。
    UPDATE tab1 SET col1=col1+1 WHERE col2=2，每次执行的结果都会发生变化，这种不是幂等的。
    insert into user(userid,name) values(1,‘a’) 如userid为唯一主键，即重复操作上面的业务，只会插入一条用户数据，具备幂等性。
    如userid不是主键，可以重复，那上面业务多次操作，数据都会新增多条，不具备幂等性。
    delete from user where userid=1，多次操作，结果一样，具备幂等性
    
    如何保证幂等
    唯一主键
    利用数据库主键唯一的特性，解决在执行insert语句时的幂等性问题。（在分库分表情况下无效）
    
    去重表
    适用于有唯一标识的插入场景，新建一张去重表，添加唯一索引，当执行插入操作时，将唯一标识保存到去重表唯一索引字段，当重复请求时，因为有唯一约束，导致数据库抛异常回滚。
    
    乐观锁机制
    适用于更新场景，update t_goods set count = count -1 , version = version + 1 where good_id=2 and version = 1
    乐观锁只是在更新数据那一刻锁表，其他时间不锁表
    
    状态机控制
    这种方法适合在有状态机流转的情况下，比如就会订单的创建和付款，订单的付款肯定是在之前，这时我们可以通过在设计状态字段时，使用int类型，并且通过值类型的大小来做幂等，比如订单的创建为0，付款成功为100。付款失败为99
    
    对外提供接口的api如何保证幂等
    对外提供接口为了支持幂等调用，接口有两个字段必须传，一个是来源source，一个是来源方序列号seq，这个两个字段在提供方系统里面做联合唯一索引，这样当第三方调用时，先在本方系统里面查询一下，是否已经处理过，返回相应处理结果；没有处理过，进行相应处理，返回结果。
    
    
