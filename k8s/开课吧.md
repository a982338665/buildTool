
#k8s三部曲之kubernetes与微服务的完美结合
#kubernetes

**1.k8s架构及应用场景：**
    
    1.k8s在企业中的应用场景：
        1.自动化运维平台
            ・中小型企业，降本增效
            ・大型互联网公司，更加会使用
        2.充分的利用服务器资源：
            案例：
                并发量200请求，服务器 2cpu 4g x86
                静态资源请求 150 访问CDN，nginx，缓存
                动态资源请求 50  访问数据库，把数据读入内存
                估算服务器资源，只考虑内存，不考虑程序的响应时间（RT），不考虑cpu的切换时间
                静态资源：一个线程假设占2M内存，java里是1M， 150*2 = 300M
                动态资源：一个线程假设占10M内存，50*10 = 500M
                和为 300+500 = 800M 即200请求占用800M
                此台服务器并发能力（QPS）约为： 800个请求约为 3200M，剩下800M作为操作系统占用内存
                那么要充分利用服务器资源：并发请求大概要达到800（只考虑内存，所以实际上无法达到800QPS，实际中要考虑cpu切换时间，程序响应时间）
            k8s使用容器化的方式，充分利用服务资源
        3.服务的无缝迁移 
            开发环境 - 测试环境 -生产环境
            容器化方式做到无缝迁移
            k8s是管理容器的
    2.服务部署模式变迁&服务部署模式变化的问题思考
        1.物理机部署
        2.虚拟机部署：虚拟机分隔物理资源 -充分利用服务器资源
        3.容器化部署：轻量级-效率高
        4.SOA架构，微服务拆分，如何管理
            虚拟机 openstack
            容器化 k8s
        5.问题：
            如何对服务进行横向拓展
            容器宕机怎么办
            数据恢复问题
            新版本发布问题，更新不影响（滚动更新）
            容器监控问题
            容器如何调度创建
            数据安全性如何保证
            解决方案：K8s管理构建自动化
    3.云架构&云原生
        1.云和k8s的关系：
            云：使用容器构建的一套服务集群网络
        2.云架构：
            ・iaas：基础设施即服务
                用户：租用云主机（购买，分配权限），不用考虑网络，dns，硬件环境
                运营商：阿里云，腾讯云等，提供网络，存储，dns，即基础设施服务
            ・paas：平台即服务
                Mysql，oraclet，mq
            ・saas：软件即服务
                钉钉：针对于每个公司提供一套系统
                财务管理
            ・serverless：
                无服务，站在用户角度考虑问题，用户只需要使用云服务器即可，不需要关心软件，硬件
        3.云原生：
            为了让应用程序（项目，服务软件）都运行在云上的解决方案，这样的方案就叫做云原生
            特点：
                容器化部署
                微服务 web服务架构师，微服务架构
                CI/CD 可持续交付，可持续部署
                DevOps 开发运维不可分
    4.k8s架构原理
        1.google使用go语言开发，容器管理领先全球，borg系统
        2.k8s集群：
            ・master节点
                api server ：：k8s的网关，请求都会经过此处转发
                scheduler：：调度器，使用调度算法，将请求资源调度到某个node节点
                controller：：控制器，维护k8s资源对象，CRUD等增删改查
                edct：：存储资源对象，做服务注册与发现等
            ・node节点
                docker：：运行容器的基础环境，容器引擎
                kubelet：：在每个node节点都存在一份，在node节点上的资源操作指令由kubelet来执行，从etct扫描匹配获取相关数据信息，然后执行指令
                kube-proxy：：代理服务，做负载均衡
                fluentd：：日志收集服务
                pod：：是k8s管理的基本单位，也称最小单元，内部是容器，k8s是管理pod，而非容器，通过pod间接管理容器，pod内部有一个或多个容器
            一个master多个node
        3.特点：
            kubelet负责本地的pod维护
            kube-proxy负责负载均衡，在多个pod直接做负载均衡
            
**2.深入认识核心组件原理：（资源对象）**

    1.pod的核心原理：
        pod：也是一个容器，容器中装的是docker创建的容器，pod是一个虚拟化分组，有自己的ip地址，主机名，相当于独立的沙箱环境
        pod相当于独立主机，可以封装一个或多个容器
        一个pod中要么部署一个服务，要么部署一组相关服务 {nginx web mysql} = pod；链式调用的服务成为一组相关的服务  
        实现服务集群：或者扩容
            只需要复制pod即可
        Pod底层网络和数据存储:
            pause容器，会共享pod中的网络和存储，会让里面的服务之间通信更高效
        pod底层：
            ・pod内部容器创建之前，必须先创建pause容器
            ・服务容器之间等同于本地访问，性能高
    2.replicaset副本控制器：
        ・ReplicationController 副本控制器
        ・replicaset副本控制器
        副本控制器基本理解：控制pod的副本（服务集群）数量，永远与预期设定的数量保持一致即可
        前提：replicas = 3 （3个副本）
        如果一个pod宕机，副本控制器会立即创建一个新的补充，使得与预期设定的数量保持一致，此为副本控制器的作用，以上两个副本控制器均有此功能
        两个副本控制器的区别：
            replicaset：可以使用标签单选或者复合选择
            ReplicationController：只能单选
        新版的k8s中，replicaset副本控制器被使用，功能更强大
    3.deployment资源部署对象：
        服务部署结构模型：
            deployment对象 --> Replicaset --> pod
            Replicaset不支持滚动更新，deployment支持滚动更新，通常跟Replcaset一起使用
            滚动更新的时候：deployment新建一个replicaset，然后持续发版，重新新建pod，出问题可以回滚至上一个Replicaset
        滚动更新：持续发版，注意替换，版本升级
    4.statefulset用来部署有状态的服务：为了解决有状态服务进行容器化部署的问题
        部署模型：
            statefulset对象 --> Replicaset --> pod -->持久化
            D:\git-20191022\buildTool\k8s\statefulset部署模型.png
        有状态服务：
            1.有实时数据需要存储
            2.有状态服务集群中，把某个服务抽离出去，一段时间后再次加入机器网络，如果集群网络无法使用
        无状态服务：
            1.无实时数据需要存储
            2.有状态服务集群中，把某个服务抽离出去，一段时间后再次加入机器网络，对集群无影响
        思考：mysql使用容器化部署，有什么问题？
            ・容器是有生命周期的，一旦宕机，数据可能会丢失
            ・pod部署，pod有生命周期，数据丢失，所以容器并不适合部署有数据有状态服务
            对于k8s不能使用deployment部署有状态服务，通常情况下他用来部署无状态服务
            对有状态服务部署使用statefulset
**3.注册与发现：**
